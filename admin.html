<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .file-icons a { font-size: 22px; text-decoration: none; }
  .file-icons a:hover { opacity: 0.7; }
</style>
</head>
<body class="p-4">

<h2>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Admin)</h2>
<hr>

<div id="loginBox" class="mb-4">
  <h5>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h5>
  <div class="row g-2">
    <div class="col-md-3">
      <input id="user" class="form-control" placeholder="Username">
    </div>
    <div class="col-md-3">
      <input id="pass" class="form-control" type="password" placeholder="Password">
    </div>
    <div class="col-md-2">
      <button class="btn btn-dark w-100" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</div>

<div id="adminPanel" style="display:none;">
  <div class="d-flex justify-content-between mb-2">
    <h5>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <button class="btn btn-outline-primary btn-sm" onclick="printSummary()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
  <div id="adminTable"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw3yEQIsaAVChxIXyfdWOrzD_73kC3T6RBGJc-hj9c6JhHcNW22AlI98y5RmYnGIXnmgQ/exec";
const SHEET_ID = "19HF10SiHNtUyT9ikq5TriUJO6KkK_y7OTS12W-2Xmck";

let ADMIN_LOGGED_IN = false;

function doLogin(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();

  if (u === "admin1" && p === "planuph334") {
    ADMIN_LOGGED_IN = true;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadAdminRequests();
  } else {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "Username/Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
  }
}

async function loadAdminRequests(){
  const res = await fetch(API + "?action=listRequests&sheetId=" + SHEET_ID);
  const json = await res.json();
  renderAdminTable(json.data || []);
}

function renderAdminTable(rows){
  let html = `
  <table class="table table-bordered table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
        <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody>
  `;

  rows.forEach((r, idx) => {
    const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleDateString("th-TH") : "";
    html += `
      <tr>
        <td>${idx}</td>
        <td>${dateStr}</td>
        <td>${r.fullname}</td>
        <td>${r.itemName}</td>
        <td>${r.department || ""}</td>
        <td>${r.status || ""}</td>
        <td>${r.note || ""}</td>
        <td>
          <span class="file-icons d-flex gap-2">
            <a href="${r.spec}" target="_blank" title="‡∏™‡πÄ‡∏õ‡∏Ñ">üìÑ</a>
            <a href="${r.quoteMin}" target="_blank" title="‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">üí∞</a>
            <a href="${r.quote1}" target="_blank" title="‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 1">üìë</a>
            <a href="${r.quote2}" target="_blank" title="‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 2">üìë</a>
          </span>
        </td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-success" onclick="approve(${idx})">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="btn btn-warning" onclick="markEdit(${idx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="delRow(${idx})">‡∏•‡∏ö</button>
            <button class="btn btn-secondary" onclick="printOne(${idx})">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
          </div>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("adminTable").innerHTML = html;
}

async function callAdminAction(index, sub, note=""){
  const params = new URLSearchParams({
    action: "adminAction",
    sheetId: SHEET_ID,
    index: index,
    sub: sub
  });
  if (note) params.append("note", note);

  const res = await fetch(API + "?" + params.toString());
  const json = await res.json();
  if (!json.success) {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", json.message || "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  } else {
    loadAdminRequests();
  }
}

function approve(index){
  Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  }).then(r=>{
    if (r.isConfirmed) {
      callAdminAction(index, "approve");
    }
  });
}

function markEdit(index){
  Swal.fire({
    title: "‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏",
    input: "textarea",
    inputLabel: "‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
    inputPlaceholder: "‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà...",
    showCancelButton: true,
    confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
  }).then(r=>{
    if (r.isConfirmed) {
      callAdminAction(index, "edit", r.value || "");
    }
  });
}

function delRow(index){
  Swal.fire({
    title: "‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?",
    text: "‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏•‡∏ö",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  }).then(r=>{
    if (r.isConfirmed) {
      callAdminAction(index, "delete");
    }
  });
}

function printOne(index){
  window.open("report.html?index=" + index, "_blank");
}

function printSummary(){
  window.open("report.html?mode=summary", "_blank");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
