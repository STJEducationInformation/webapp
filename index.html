<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .file-icons a { font-size: 24px; text-decoration: none; }
  .file-icons a:hover { opacity: 0.7; }
</style>

</head>
<body class="p-4">

<h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>
<hr>

<!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
<div id="status"></div>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
<form id="reqForm" enctype="multipart/form-data">

  <input type="hidden" name="action" value="uploadRequest">
  <input type="hidden" name="sheetId" value="19HF10SiHNtUyT9ikq5TriUJO6KkK_y7OTS12W-2Xmck">

  <div class="row g-3">
    
    <div class="col-md-4">
      <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</label>
      <input type="text" name="fullname" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
      <input type="text" name="itemName" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" name="quantity" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">‡πÑ‡∏ü‡∏•‡πå‡∏™‡πÄ‡∏õ‡∏Ñ (Word)</label>
      <input type="file" name="specFile" accept=".doc,.docx" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (PDF)</label>
      <input type="file" name="quoteMin" accept="application/pdf" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 1 (PDF)</label>
      <input type="file" name="quote1" accept="application/pdf" class="form-control">
    </div>

    <div class="col-md-6">
      <label class="form-label">‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 2 (PDF)</label>
      <input type="file" name="quote2" accept="application/pdf" class="form-control">
    </div>

  </div>

  <button class="btn btn-primary mt-3" type="submit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
</form>

<hr class="my-4">

<h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
<div id="requestTable"></div>

<hr>

<!-- ‡∏õ‡∏∏‡πà‡∏° Admin -->
<div class="d-flex justify-content-end">
  <button class="btn btn-dark" id="adminBtn">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
</div>


<!-- Modal ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå -->
<div class="modal fade" id="fileModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="fileModalBody"></div>
    </div>
  </div>
</div>


<script>
const API = "https://script.google.com/macros/s/AKfycbztkOFDCGLsW1Albzxn1nshbs_UnqzZaL1G5LiWD-vF2zmpglAhmBCpjjXVBjJYA4BtZw/exec";


/*********** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64 ***********/
function encodeFile(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}


/*********** ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö POST ***********/
document.getElementById("reqForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö ‚Üí Base64
  for (let field of ["specFile", "quoteMin", "quote1", "quote2"]) {
    let file = form[field].files[0];
    if (file) {
      const base64 = await encodeFile(file);
      formData.set(field, base64);
      formData.set(field + "_name", file.name);
      formData.set(field + "_type", file.type);
    }
  }

  Swal.fire({title:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...", didOpen:()=>Swal.showLoading()});

  let res = await fetch(API, { method: "POST", body: formData });
  let json = await res.json();

  Swal.close();

  if (json.success) {
    Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
    loadRequests();
  } else {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", json.message, "error");
  }
});



/*********** ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ ***********/
async function loadRequests() {
  const url = API + "?action=listRequests&sheetId=19HF10SiHNtUyT9ikq5TriUJO6KkK_y7OTS12W-2Xmck";
  const res = await fetch(url);
  const json = await res.json();
  showTable(json.data);
}

function showTable(rows) {
  let html = `
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
        <th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
      </tr>
    </thead>
    <tbody>
  `;

  rows.forEach((r, idx) => {
    html += `
      <tr>
        <td>${r.fullname}</td>
        <td>${r.itemName}</td>
        <td>${r.quantity}</td>
        <td>
          <span class="file-icons d-flex gap-2">
            <a href="${r.spec}" target="_blank" title="‡∏™‡πÄ‡∏õ‡∏Ñ">üìÑ</a>
            <a href="${r.quoteMin}" target="_blank" title="‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">üí∞</a>
            <a href="${r.quote1}" target="_blank" title="‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 1">üìë</a>
            <a href="${r.quote2}" target="_blank" title="‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 2">üìë</a>
          </span>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("requestTable").innerHTML = html;
}

loadRequests();



/*********** Admin Login ***********/
document.getElementById("adminBtn").onclick = async () => {
  const { value: login } = await Swal.fire({
    title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà",
    html: `
      <input id="user" class="swal2-input" placeholder="Username">
      <input id="pass" class="swal2-input" type="password" placeholder="Password">
    `,
    preConfirm: () => ({
      user: document.getElementById("user").value,
      pass: document.getElementById("pass").value
    })
  });

  if (!login) return;

  if (login.user === "admin1" && login.pass === "planuph334") {
    Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß", "success");
    adminPanel();
  } else {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
  }
};


/*********** Admin Panel ***********/
async function adminPanel() {

  const url = API + "?action=listRequests&sheetId=19HF10SiHNtUyT9ikq5TriUJO6KkK_y7OTS12W-2Xmck";
  const res = await fetch(url);
  const json = await res.json();

  let html = `
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>#</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
      </tr>
    </thead>
    <tbody>
  `;

  json.data.forEach((r, idx) => {
    html += `
      <tr>
        <td>${idx}</td>
        <td>${r.fullname}</td>
        <td>${r.itemName}</td>
        <td>${r.status}</td>
        <td>
          <span class="file-icons d-flex gap-2">
            <a href="${r.spec}" target="_blank">üìÑ</a>
            <a href="${r.quoteMin}" target="_blank">üí∞</a>
            <a href="${r.quote1}" target="_blank">üìë</a>
            <a href="${r.quote2}" target="_blank">üìë</a>
          </span>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";

  Swal.fire({
    title: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    width: "900px",
    html: html
  });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
