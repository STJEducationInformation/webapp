<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-size: 14px; }
  .file-icons a { font-size: 20px; margin-right: 6px; }
</style>
</head>
<body class="p-4">

<div id="content">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw3yEQIsaAVChxIXyfdWOrzD_73kC3T6RBGJc-hj9c6JhHcNW22AlI98y5RmYnGIXnmgQ/exec";
const SHEET_ID = "19HF10SiHNtUyT9ikq5TriUJO6KkK_y7OTS12W-2Xmck";
const params = new URLSearchParams(location.search);
const indexParam = params.get("index");
const mode = params.get("mode");

(async function main(){
  if (indexParam !== null) {
    await renderSingle(Number(indexParam));
  } else if (mode === "summary") {
    await renderSummary();
  } else {
    document.getElementById("content").innerHTML =
      "<div class='alert alert-info'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ index ‡∏´‡∏£‡∏∑‡∏≠ mode=summary ‡πÉ‡∏ô URL</div>";
  }
})();

async function renderSingle(idx){
  const res = await fetch(API + "?action=listRequests&sheetId=" + SHEET_ID);
  const json = await res.json();
  const r = json.data[idx];
  if (!r) {
    document.getElementById("content").innerHTML =
      "<div class='alert alert-danger'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</div>";
    return;
  }

  const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleDateString("th-TH") : "";

  document.getElementById("content").innerHTML = `
    <h4 class="mb-3">‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</h4>
    <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${dateStr}</p>
    <p><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</b> ${r.fullname}</p>
    <p><b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</b> ${r.position || ""}</p>
    <p><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</b> ${r.department || ""}</p>
    <p><b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå:</b> ${r.itemName}</p>
    <p><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ${r.quantity} ${r.unit || ""}</p>
    <p><b>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏£‡∏ß‡∏° VAT):</b> ${r.priceVat || ""}</p>
    <p><b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô:</b> ${r.reason || ""}</p>
    <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${r.status || ""}</p>
    <p><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</b> ${r.note || ""}</p>

    <h5 class="mt-4">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</h5>
    <div class="file-icons">
      <a href="${r.spec}" target="_blank">üìÑ ‡∏™‡πÄ‡∏õ‡∏Ñ</a>
      <a href="${r.quoteMin}" target="_blank">üí∞ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</a>
      <a href="${r.quote1}" target="_blank">üìë ‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 1</a>
      <a href="${r.quote2}" target="_blank">üìë ‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 2</a>
      ${r.imageUrl ? `<a href="${r.imageUrl}" target="_blank">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</a>` : ""}
    </div>
  `;

  window.print();
}

async function renderSummary(){
  const res = await fetch(API + "?action=generateReport&sheetId=" + SHEET_ID);
  const json = await res.json();
  const rows = json.data || [];

  let html = `
    <h4 class="mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h4>
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏£‡∏ß‡∏° VAT)</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach((r, idx) => {
    const dateStr = r[0] ? new Date(r[0]).toLocaleDateString("th-TH") : "";
    html += `
      <tr>
        <td>${idx+1}</td>
        <td>${dateStr}</td>
        <td>${r[2] || ""}</td>
        <td>${r[19] || ""}</td>
        <td>${r[3] || ""}</td>
        <td>${r[4] || ""} ${r[5] || ""}</td>
        <td>${r[6] || ""}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("content").innerHTML = html;

  window.print();
}
</script>
</body>
</html>